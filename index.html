<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>2D Particle Collider</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
      color: #fff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    canvas {
      display: block;
      background: #000;
    }
    #controls {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 10;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      background: rgba(20, 20, 30, 0.85);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(100, 150, 255, 0.2);
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      background: linear-gradient(145deg, #1e3a8a, #2563eb);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
    button:hover {
      background: linear-gradient(145deg, #2563eb, #3b82f6);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
    }
    button:active {
      transform: translateY(1px);
    }
    #resetBtn {
      background: linear-gradient(145deg, #1f2937, #374151);
    }
    #resetBtn:hover {
      background: linear-gradient(145deg, #374151, #4b5563);
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #e2e8f0;
      font-size: 14px;
      user-select: none;
    }
    .slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(240, 240, 240, 0.9);
      padding: 8px 15px;
      border-radius: 20px;
      position: relative;
      height: 36px;
    }
    .slider-label {
      color: #333;
      font-weight: 500;
      white-space: nowrap;
    }
    input[type="range"] {
      -webkit-appearance: none;
      width: 120px;
      height: 6px;
      border-radius: 3px;
      background: #ddd;
      outline: none;
      position: relative;
    }
    /* FIX: Center the slider thumb vertically on the track */
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #10b981;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(16, 185, 129, 0.5);
      margin-top: -6px; /* (18px thumb height / 2) - (6px track height / 2) */
    }
    input[type="range"]::-webkit-slider-runnable-track {
      background: linear-gradient(to right, #10b981 0%, #10b981 var(--value, 0%), #ddd var(--value, 0%), #ddd 100%);
      border-radius: 3px;
      height: 6px;
    }
    input[type="number"] {
      width: 60px;
      padding: 5px;
      background: rgba(30, 30, 50, 0.8);
      border: 1px solid #4f46e5;
      border-radius: 4px;
      color: white;
    }
    #particleModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(10, 15, 30, 0.95);
      border: 2px solid #4f46e5;
      border-radius: 15px;
      padding: 25px;
      display: none;
      z-index: 20;
      color: white;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
      max-height: 80vh;
      overflow-y: auto;
    }
    #particleModal.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, -45%); }
      to { opacity: 1; transform: translate(-50%, -50%); }
    }
    .grid-label {
      font-family: Arial, sans-serif;
      margin: 15px 0 10px;
      color: #93c5fd;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 14px;
    }
    .particle-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin: 15px 0;
    }
    .particle-button {
      padding: 12px;
      text-align: center;
      border: 1px solid #4f46e5;
      border-radius: 8px;
      cursor: pointer;
      background: rgba(30, 30, 50, 0.8);
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .particle-button:hover {
      background: rgba(79, 70, 229, 0.3);
      transform: translateY(-2px);
    }
    .particle-color {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: inline-block;
    }
    .particle-name {
      font-size: 14px;
      font-weight: 500;
    }
    .beam-line {
      position: absolute;
      height: 2px;
      background: rgba(100, 200, 255, 0.2);
      z-index: 1;
    }
    #topBeam {
      top: 25%;
      left: 0;
      width: 100%;
    }
    #bottomBeam {
      top: 75%;
      left: 0;
      width: 100%;
    }
    .instructions-btn {
      position: absolute;
      top: 20px;
      right: 165px;
      z-index: 10;
      background: rgba(20, 20, 30, 0.85);
      border: 1px solid rgba(100, 150, 255, 0.2);
      border-radius: 8px;
      padding: 10px 15px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .instructions-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(10, 15, 30, 0.95);
      border: 2px solid #4f46e5;
      border-radius: 15px;
      padding: 25px;
      display: none;
      z-index: 20;
      color: white;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
    }
    .instructions-modal.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    .instructions-modal h2 {
      margin-top: 0;
      color: #93c5fd;
    }
    .instructions-modal ul {
      padding-left: 20px;
    }
    .instructions-modal li {
      margin-bottom: 10px;
      line-height: 1.5;
    }
    .close-instructions {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: #ff6b6b;
      font-size: 24px;
      cursor: pointer;
    }
    #leftParticleBtn, #rightParticleBtn {
      position: absolute;
      bottom: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 15px;
      z-index: 10;
      background: rgba(20, 20, 30, 0.85);
      border: 1px solid rgba(100, 150, 255, 0.2);
      border-radius: 12px;
      min-width: 160px;
    }
    #leftParticleBtn {
      left: 20px;
    }
    #rightParticleBtn {
      right: 20px;
    }
    .particle-preview {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: #f44336;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
      cursor: pointer;
    }
    .particle-info {
      text-align: center;
      font-size: 12px;
      color: #a0aec0;
    }
    .particle-info div {
      margin: 2px 0;
    }
    #statsToggle {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 10;
      background: rgba(20, 20, 30, 0.85);
      border: 1px solid rgba(100, 150, 255, 0.2);
      border-radius: 8px;
      padding: 10px 15px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: white;
    }
    #statsDisplay {
      position: absolute;
      top: 70px;
      right: 20px;
      z-index: 10;
      background: rgba(20, 20, 30, 0.85);
      border: 1px solid rgba(100, 150, 255, 0.2);
      border-radius: 8px;
      padding: 15px;
      font-size: 14px;
      color: #e2e8f0;
      display: none;
      min-width: 300px;
      max-height: 80vh;
      overflow-y: auto;
    }
    #statsDisplay.show {
      display: block;
    }
    .stat-section {
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(100, 150, 255, 0.2);
    }
    .stat-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    .stat-section-title {
      font-weight: bold;
      color: #64b5f6;
      margin-bottom: 8px;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .stat-section-title::after {
      content: "‚ñº";
      transition: transform 0.3s ease;
    }
    .stat-section-title.collapsed::after {
      transform: rotate(-90deg);
    }
    .stat-content {
      max-height: 1000px;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .stat-content.collapsed {
      max-height: 0;
    }
    .stat-item {
      margin: 5px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .stat-value {
      font-weight: bold;
      color: #a78bfa;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 12px;
    }
    th, td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    th {
      background: rgba(100, 150, 255, 0.2);
      font-weight: bold;
    }
    .chart-container {
      height: 100px;
      margin: 10px 0;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 5px;
      position: relative;
      overflow: hidden;
    }
    #momentumToggle {
      margin-left: 15px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    #momentumToggle input {
      margin: 0;
    }
    .view-toggle {
      display: flex;
      gap: 5px;
      margin-left: 10px;
    }
    .view-toggle button {
      padding: 3px 8px;
      font-size: 12px;
      background: rgba(79, 70, 229, 0.3);
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
    }
    .view-toggle button.active {
      background: #4f46e5;
    }
    .table-view {
      display: none;
      margin-top: 10px;
    }
    .table-view.show {
      display: block;
    }
    .table-view table {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
    }
    .table-view th, .table-view td {
      padding: 4px 6px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .table-view th {
      background: rgba(100, 150, 255, 0.2);
      position: sticky;
      top: 0;
    }
    .hidden {
        display: none !important;
    }
    #floatingGraphWindow {
      position: fixed;
      z-index: 1000;
      background: rgba(20, 20, 30, 0.95);
      border: 2px solid rgba(100, 150, 255, 0.5);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
      display: none;
      min-width: 400px;
      max-width: 90vw;
      user-select: none;
    }
    #floatingGraphWindow.show {
      display: block;
    }
    #floatingGraphHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      color: #64b5f6;
      font-weight: bold;
      cursor: move;
    }
    #closeFloatingGraph {
      background: none;
      border: none;
      color: #ff6b6b;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #floatingGraphTitle {
      margin: 0;
      font-size: 16px;
    }
    #floatingGraphCanvasContainer {
      height: 200px;
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      overflow: hidden;
    }
    #floatingGraphCanvasContainer canvas {
       width: 100%;
       height: 100%;
       display: block;
    }
  </style>
</head>
<body>
  <div class="beam-line" id="topBeam"></div>
  <div class="beam-line" id="bottomBeam"></div>
  <div id="controls">
    <button id="playPauseBtn">‚ñ∂Ô∏è</button>
    <button id="resetBtn">Reset</button>
    <button id="oneParticleBtn">1 Particle</button>
    <div class="slider-container">
      <span class="slider-label">Time Scale:</span>
      <input id="timeScaleInput" type="range" min="0.1" max="5" step="0.1" value="1" />
      <span id="timeScaleValue">1.0</span>
    </div>
    <label for="particleCountInput">
      Particle Count:
      <input id="particleCountInput" type="number" min="1" max="10" value="4" />
    </label>
    <label id="momentumToggle">
      <input type="checkbox" id="momentumCheckbox">
      <span>Show Momentum</span>
    </label>
  </div>
  <button id="statsToggle">
    <input type="checkbox" id="statsCheckbox" style="display:none;">
    <label for="statsCheckbox">Statistics</label>
  </button>
  <div id="statsDisplay">
    <!-- FEATURE: Added "Make CSV" button -->
    <button id="exportCsvBtn" style="width:100%; margin-bottom: 15px;">Make CSV</button>
    
    <div class="stat-section">
      <div class="stat-section-title">üì¶ Particle Overview</div>
      <div class="stat-content">
        <div class="stat-item">
          <span>Total Particles: <span id="totalParticles" class="stat-value">0</span></span>
          <div class="view-toggle">
            <button class="graph-btn" data-metric="totalParticles">Graph</button>
            <button class="table-btn active" data-metric="totalParticles">Table</button>
          </div>
        </div>
        <div class="chart-container hidden" id="totalParticlesChart"></div>
        <div class="table-view show" id="totalParticlesTable">
          <table>
            <thead> <tr> <th>Time (s)</th> <th>Value</th> </tr> </thead>
            <tbody id="totalParticlesTableBody"></tbody>
          </table>
        </div>
        <div class="stat-item">
          <span>Active / Decayed: <span id="activeDecayed" class="stat-value">0 / 0</span></span>
          <div class="view-toggle">
            <button class="graph-btn" data-metric="activeDecayed">Graph</button>
            <button class="table-btn active" data-metric="activeDecayed">Table</button>
          </div>
        </div>
        <div class="chart-container hidden" id="activeDecayedChart"></div>
        <div class="table-view show" id="activeDecayedTable">
          <table>
            <thead> <tr> <th>Time (s)</th> <th>Active</th> <th>Decayed</th> </tr> </thead>
            <tbody id="activeDecayedTableBody"></tbody>
          </table>
        </div>
        <div class="stat-item">
          <span>From Beams: <span id="beamParticles" class="stat-value">0</span></span>
          <div class="view-toggle">
            <button class="graph-btn" data-metric="beamParticles">Graph</button>
            <button class="table-btn active" data-metric="beamParticles">Table</button>
          </div>
        </div>
        <div class="chart-container hidden" id="beamParticlesChart"></div>
        <div class="table-view show" id="beamParticlesTable">
          <table>
            <thead> <tr> <th>Time (s)</th> <th>Value</th> </tr> </thead>
            <tbody id="beamParticlesTableBody"></tbody>
          </table>
        </div>
        <div class="stat-item">
          <span>From Decays: <span id="decayParticles" class="stat-value">0</span></span>
          <div class="view-toggle">
            <button class="graph-btn" data-metric="decayParticles">Graph</button>
            <button class="table-btn active" data-metric="decayParticles">Table</button>
          </div>
        </div>
        <div class="chart-container hidden" id="decayParticlesChart"></div>
        <div class="table-view show" id="decayParticlesTable">
          <table>
            <thead> <tr> <th>Time (s)</th> <th>Value</th> </tr> </thead>
            <tbody id="decayParticlesTableBody"></tbody>
          </table>
        </div>
        <div class="stat-item">
          <span>Max Decay Chain: <span id="maxDecayChain" class="stat-value">0</span></span>
          <div class="view-toggle">
            <button class="graph-btn" data-metric="maxDecayChain">Graph</button>
            <button class="table-btn active" data-metric="maxDecayChain">Table</button>
          </div>
        </div>
        <div class="chart-container hidden" id="maxDecayChainChart"></div>
        <div class="table-view show" id="maxDecayChainTable">
          <table>
            <thead> <tr> <th>Time (s)</th> <th>Value</th> </tr> </thead>
            <tbody id="maxDecayChainTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="stat-section">
      <div class="stat-section-title">üß¨ Composition Breakdown</div>
      <div class="stat-content">
        <table>
          <thead> <tr> <th>Type</th> <th>Count</th> <th>Percentage</th> </tr> </thead>
          <tbody id="compositionTable"> <tr> <td colspan="3">No data</td> </tr> </tbody>
        </table>
        <div class="stat-item">
          <span>Composition</span>
          <div class="view-toggle"> <button class="graph-btn" data-metric="composition">Graph</button> </div>
        </div>
        <div class="chart-container" id="compositionChart"></div>
      </div>
    </div>
    <div class="stat-section">
      <div class="stat-section-title">üìà Speed & Energy</div>
      <div class="stat-content">
        <table>
          <thead> <tr> <th>Metric</th> <th>Value</th> </tr> </thead>
          <tbody>
            <tr> <td>Avg Speed</td> <td><span id="avgSpeed" class="stat-value">0.00</span></td> </tr>
            <tr> <td>Avg Energy</td> <td><span id="avgEnergy" class="stat-value">0.00</span></td> </tr>
            <tr> <td>Max Energy</td> <td><span id="maxEnergy" class="stat-value">0.00 (None)</span></td> </tr>
            <tr> <td>Min Energy</td> <td><span id="minEnergy" class="stat-value">0.00 (None)</span></td> </tr>
          </tbody>
        </table>
        <div class="stat-item">
          <span>Avg Speed</span>
          <div class="view-toggle">
            <button class="graph-btn" data-metric="avgSpeed">Graph</button>
            <button class="table-btn active" data-metric="avgSpeed">Table</button>
          </div>
        </div>
        <div class="chart-container hidden" id="avgSpeedChart"></div>
        <div class="table-view show" id="avgSpeedTable">
          <table>
            <thead> <tr> <th>Time (s)</th> <th>Value</th> </tr> </thead>
            <tbody id="avgSpeedTableBody"></tbody>
          </table>
        </div>
        <div class="stat-item">
          <span>Avg Energy</span>
          <div class="view-toggle">
            <button class="graph-btn" data-metric="avgEnergy">Graph</button>
            <button class="table-btn active" data-metric="avgEnergy">Table</button>
          </div>
        </div>
        <div class="chart-container hidden" id="avgEnergyChart"></div>
        <div class="table-view show" id="avgEnergyTable">
          <table>
            <thead> <tr> <th>Time (s)</th> <th>Value</th> </tr> </thead>
            <tbody id="avgEnergyTableBody"></tbody>
          </table>
        </div>
        <div class="stat-item">
          <span>Max Energy</span>
          <div class="view-toggle">
            <button class="graph-btn" data-metric="maxEnergy">Graph</button>
            <button class="table-btn active" data-metric="maxEnergy">Table</button>
          </div>
        </div>
        <div class="chart-container hidden" id="maxEnergyChart"></div>
        <div class="table-view show" id="maxEnergyTable">
          <table>
            <thead> <tr> <th>Time (s)</th> <th>Value</th> <th>Particle</th> </tr> </thead>
            <tbody id="maxEnergyTableBody"></tbody>
          </table>
        </div>
        <div class="stat-item">
          <span>Min Energy</span>
          <div class="view-toggle">
            <button class="graph-btn" data-metric="minEnergy">Graph</button>
            <button class="table-btn active" data-metric="minEnergy">Table</button>
          </div>
        </div>
        <div class="chart-container hidden" id="minEnergyChart"></div>
        <div class="table-view show" id="minEnergyTable">
          <table>
            <thead> <tr> <th>Time (s)</th> <th>Value</th> <th>Particle</th> </tr> </thead>
            <tbody id="minEnergyTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="stat-section">
      <div class="stat-section-title">üåÄ Distance & Lifetime</div>
      <div class="stat-content">
        <table>
          <thead> <tr> <th>Metric</th> <th>Value</th> </tr> </thead>
          <tbody>
            <tr> <td>Total Distance</td> <td><span id="totalDistance" class="stat-value">0.00</span></td> </tr>
            <tr> <td>Avg Distance</td> <td><span id="avgDistance" class="stat-value">0.00</span></td> </tr>
            <tr> <td>Avg Lifetime</td> <td><span id="avgLifetime" class="stat-value">0.00</span></td> </tr>
          </tbody>
        </table>
        <div class="stat-item">
          <span>Total Distance</span>
          <div class="view-toggle">
            <button class="graph-btn" data-metric="totalDistance">Graph</button>
            <button class="table-btn active" data-metric="totalDistance">Table</button>
          </div>
        </div>
        <div class="chart-container hidden" id="totalDistanceChart"></div>
        <div class="table-view show" id="totalDistanceTable">
          <table>
            <thead> <tr> <th>Time (s)</th> <th>Value</th> </tr> </thead>
            <tbody id="totalDistanceTableBody"></tbody>
          </table>
        </div>
        <div class="stat-item">
          <span>Avg Distance</span>
          <div class="view-toggle">
            <button class="graph-btn" data-metric="avgDistance">Graph</button>
            <button class="table-btn active" data-metric="avgDistance">Table</button>
          </div>
        </div>
        <div class="chart-container hidden" id="avgDistanceChart"></div>
        <div class="table-view show" id="avgDistanceTable">
          <table>
            <thead> <tr> <th>Time (s)</th> <th>Value</th> </tr> </thead>
            <tbody id="avgDistanceTableBody"></tbody>
          </table>
        </div>
        <div class="stat-item">
          <span>Avg Lifetime</span>
          <div class="view-toggle">
            <button class="graph-btn" data-metric="avgLifetime">Graph</button>
            <button class="table-btn active" data-metric="avgLifetime">Table</button>
          </div>
        </div>
        <div class="chart-container hidden" id="avgLifetimeChart"></div>
        <div class="table-view show" id="avgLifetimeTable">
          <table>
            <thead> <tr> <th>Time (s)</th> <th>Value</th> </tr> </thead>
            <tbody id="avgLifetimeTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="stat-section">
      <div class="stat-section-title">üí• Events (Collisions & Decays)</div>
      <div class="stat-content">
        <table>
          <thead> <tr> <th>Event</th> <th>Count</th> <th>Rate</th> </tr> </thead>
          <tbody>
            <tr> <td>Collisions</td> <td><span id="collisionCount" class="stat-value">0</span></td> <td><span id="collisionRate" class="stat-value">0.0/s</span></td> </tr>
            <tr> <td>Decays</td> <td><span id="decayCount" class="stat-value">0</span></td> <td><span id="decayRate" class="stat-value">0.0/s</span></td> </tr>
          </tbody>
        </table>
        <div class="stat-item">
          <span>Collisions</span>
          <div class="view-toggle">
            <button class="graph-btn" data-metric="collisions">Graph</button>
            <button class="table-btn active" data-metric="collisions">Table</button>
          </div>
        </div>
        <div class="chart-container hidden" id="collisionsChart"></div>
        <div class="table-view show" id="collisionsTable">
          <table>
            <thead> <tr> <th>Time (s)</th> <th>Count</th> <th>Rate</th> </tr> </thead>
            <tbody id="collisionsTableBody"></tbody>
          </table>
        </div>
        <div class="stat-item">
          <span>Decays</span>
          <div class="view-toggle">
            <button class="graph-btn" data-metric="decays">Graph</button>
            <button class="table-btn active" data-metric="decays">Table</button>
          </div>
        </div>
        <div class="chart-container hidden" id="decaysChart"></div>
        <div class="table-view show" id="decaysTable">
          <table>
            <thead> <tr> <th>Time (s)</th> <th>Count</th> <th>Rate</th> </tr> </thead>
            <tbody id="decaysTableBody"></tbody>
          </table>
        </div>
        <div class="stat-item">
          <span>Top Decay: <span id="topDecays" class="stat-value">None</span></span>
        </div>
      </div>
    </div>
    <div class="stat-section">
      <div class="stat-section-title">‚ö° Beam vs Decay Energy</div>
      <div class="stat-content">
        <div class="stat-item">
          <span>Beam Energy: <span id="beamEnergy" class="stat-value">0.00</span></span>
          <div class="view-toggle">
            <button class="graph-btn" data-metric="beamEnergy">Graph</button>
            <button class="table-btn active" data-metric="beamEnergy">Table</button>
          </div>
        </div>
        <div class="chart-container hidden" id="beamEnergyChart"></div>
        <div class="table-view show" id="beamEnergyTable">
          <table>
            <thead> <tr> <th>Time (s)</th> <th>Value</th> </tr> </thead>
            <tbody id="beamEnergyTableBody"></tbody>
          </table>
        </div>
        <div class="stat-item">
          <span>Decay Energy: <span id="decayEnergy" class="stat-value">0.00</span></span>
          <div class="view-toggle">
            <button class="graph-btn" data-metric="decayEnergy">Graph</button>
            <button class="table-btn active" data-metric="decayEnergy">Table</button>
          </div>
        </div>
        <div class="chart-container hidden" id="decayEnergyChart"></div>
        <div class="table-view show" id="decayEnergyTable">
          <table>
            <thead> <tr> <th>Time (s)</th> <th>Value</th> </tr> </thead>
            <tbody id="decayEnergyTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <button class="instructions-btn" id="instructionsBtn"> <span>?</span> How to Use </button>
  <div class="instructions-modal" id="instructionsModal">
    <button class="close-instructions" id="closeInstructions">&times;</button>
    <h2>How to Use</h2>
    <ul>
      <li>Select particle types for each beam</li>
      <li>Click ‚ñ∂Ô∏è to start a new run and data recording</li>
      <li>Click ‚è∏Ô∏è to pause the simulation</li>
      <li>Use "1 Particle" for a single collision event</li>
      <li>Click "Make CSV" in the Statistics panel to download data for the current run</li>
    </ul>
  </div>
  <button id="leftParticleBtn">
    <div class="particle-preview" id="leftParticlePreview"></div>
    <div class="particle-info">
      <div id="leftParticleName">Proton</div>
      <div id="leftParticleMass">Mass: 938.3 MeV</div>
      <div id="leftParticleCharge">Charge: +1</div>
      <div id="leftParticleLifetime">Lifetime: Stable</div>
    </div>
  </button>
  <button id="rightParticleBtn">
    <div class="particle-preview" id="rightParticlePreview"></div>
    <div class="particle-info">
      <div id="rightParticleName">Anti-Proton</div>
      <div id="rightParticleMass">Mass: 938.3 MeV</div>
      <div id="rightParticleCharge">Charge: -1</div>
      <div id="rightParticleLifetime">Lifetime: Stable</div>
    </div>
  </button>
  <div id="particleModal">
    <div id="particleModalContent">
      <h2>Select Particle Type</h2>
      <p>Choose a particle for the <span id="beamSideLabel">left</span> beam:</p>
      <div class="grid-label">Standard Model</div>
      <div class="particle-grid" id="normalParticles"></div>
      <div class="grid-label">Antimatter Counterparts</div>
      <div class="particle-grid" id="antiParticles"></div>
      <button id="closeParticleModal" style="width: 100%; margin-top: 15px;">Close</button>
    </div>
  </div>
  <div id="floatingGraphWindow">
    <div id="floatingGraphHeader">
      <h3 id="floatingGraphTitle">Metric Graph</h3>
      <button id="closeFloatingGraph">&times;</button>
    </div>
    <div id="floatingGraphCanvasContainer"></div>
  </div>
  <canvas id="sim"></canvas>
  <script>
  window.addEventListener("DOMContentLoaded", () => {
    // ... (All variable declarations are unchanged)
    const canvas = document.getElementById("sim");
    const ctx = canvas.getContext("2d");
    const playPauseBtn = document.getElementById("playPauseBtn");
    const resetBtn = document.getElementById("resetBtn");
    const oneParticleBtn = document.getElementById("oneParticleBtn");
    const timeScaleInput = document.getElementById("timeScaleInput");
    const timeScaleValue = document.getElementById("timeScaleValue");
    const particleCountInput = document.getElementById("particleCountInput");
    const instructionsBtn = document.getElementById("instructionsBtn");
    const instructionsModal = document.getElementById("instructionsModal");
    const closeInstructions = document.getElementById("closeInstructions");
    const leftParticlePreview = document.getElementById("leftParticlePreview");
    const rightParticlePreview = document.getElementById("rightParticlePreview");
    const leftParticleName = document.getElementById("leftParticleName");
    const rightParticleName = document.getElementById("rightParticleName");
    const leftParticleMass = document.getElementById("leftParticleMass");
    const rightParticleMass = document.getElementById("rightParticleMass");
    const leftParticleCharge = document.getElementById("leftParticleCharge");
    const rightParticleCharge = document.getElementById("rightParticleCharge");
    const leftParticleLifetime = document.getElementById("leftParticleLifetime");
    const rightParticleLifetime = document.getElementById("rightParticleLifetime");
    const statsToggle = document.getElementById("statsToggle");
    const statsCheckbox = document.getElementById("statsCheckbox");
    const statsDisplay = document.getElementById("statsDisplay");
    const momentumCheckbox = document.getElementById("momentumCheckbox");
    const exportCsvBtn = document.getElementById("exportCsvBtn");

    // Stats elements
    const totalParticles = document.getElementById("totalParticles");
    const activeDecayed = document.getElementById("activeDecayed");
    const beamParticles = document.getElementById("beamParticles");
    const decayParticles = document.getElementById("decayParticles");
    const maxDecayChain = document.getElementById("maxDecayChain");
    const compositionTable = document.getElementById("compositionTable");
    const avgSpeed = document.getElementById("avgSpeed");
    const avgEnergy = document.getElementById("avgEnergy");
    const maxEnergy = document.getElementById("maxEnergy");
    const minEnergy = document.getElementById("minEnergy");
    const totalDistance = document.getElementById("totalDistance");
    const avgDistance = document.getElementById("avgDistance");
    const avgLifetime = document.getElementById("avgLifetime");
    const collisionCount = document.getElementById("collisionCount");
    const collisionRate = document.getElementById("collisionRate");
    const decayCount = document.getElementById("decayCount");
    const decayRate = document.getElementById("decayRate");
    const topDecays = document.getElementById("topDecays");
    const beamEnergy = document.getElementById("beamEnergy");
    const decayEnergy = document.getElementById("decayEnergy");
    
    let timeScale = 1;
    let particleCount = 4;
    let spawnIntervalId = null;
    let collisionCounter = 0;
    let decayCounter = 0;
    let decayLog = [];
    let collisionTimes = [];
    let lastStatsUpdate = Date.now();
    let particleLifetimes = [];
    let totalSimulationTime = 0;
    
    let statsData = {};

    function resetStatsData() {
        statsData = {
            totalParticles: [], activeDecayed: [], beamParticles: [],
            decayParticles: [], maxDecayChain: [], avgSpeed: [],
            avgEnergy: [], maxEnergy: [], minEnergy: [], totalDistance: [],
            avgDistance: [], avgLifetime: [], collisions: [], decays: [],
            beamEnergy: [], decayEnergy: [], composition: []
        };
        totalSimulationTime = 0;
        collisionCounter = 0;
        decayCounter = 0;
        decayLog = [];
        collisionTimes = [];
        particleLifetimes = [];
        simulationStartTime = Date.now();
    }
    resetStatsData();

    function updateSliderBackground() {
      const value = (timeScaleInput.value - timeScaleInput.min) / (timeScaleInput.max - timeScaleInput.min) * 100;
      timeScaleInput.style.setProperty('--value', value + '%');
    }
    timeScaleInput.addEventListener("input", () => {
      timeScale = parseFloat(timeScaleInput.value) || 1;
      timeScaleValue.textContent = timeScale.toFixed(1);
      updateSliderBackground();
      if (spawnIntervalId) {
        clearInterval(spawnIntervalId);
        spawnIntervalId = setInterval(createParticles, baseSpawnInterval / timeScale);
      }
    });
    updateSliderBackground();

    particleCountInput.addEventListener("change", () => {
      particleCount = parseInt(particleCountInput.value) || 4;
      if (particleCount < 1) particleCount = 1;
      if (particleCount > 10) particleCount = 10;
      particleCountInput.value = particleCount;
    });

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    window.particles = [];
    const particles = window.particles;
    window.collisions = [];
    let collisions = window.collisions;
    let animationId = null;
    let running = false;
    const bandTop = () => canvas.height * 0.25;
    const bandBottom = () => canvas.height * 0.75;
    const baseSpawnInterval = 750;

    // ... createParticles, createSingleParticlePair, drawMomentumArrow, drawParticles, updateParticles ...
    // ... getParticleProperties, getMassValue, startDecaySequence, generateDecayProducts, detectCollisions ...
    // ... drawSimpleBarChart, updateStatsData, updateStats, updateTable, updateChart ...
    // (These functions are copied from the previous version without modification as they were correct)
    
    // NOTE: For brevity, the large blocks of unchanged code are represented by comments. 
    // The actual implementation below includes the full, correct functions.
    function createParticles() {
      const baseRadius = 6;
      const scaledRadius = baseRadius * (10 / particleCount);
      for (let i = 0; i < particleCount; i++) {
        particles.push({ x: scaledRadius + Math.random() * 30, y: bandTop() + Math.random() * (bandBottom() - bandTop()), r: scaledRadius, vx: 8 + Math.random() * 4, vy: (Math.random() - 0.5) * 2, beam: "left", color: selectedParticles.left.color, name: selectedParticles.left.name, lifetime: 1000, decayed: false, decayProducts: [], spawnTime: Date.now(), origin: "left", decayChainLength: 0, distanceTraveled: 0 });
        particles.push({ x: canvas.width - scaledRadius - Math.random() * 30, y: bandTop() + Math.random() * (bandBottom() - bandTop()), r: scaledRadius, vx: -8 - Math.random() * 4, vy: (Math.random() - 0.5) * 2, beam: "right", color: selectedParticles.right.color, name: selectedParticles.right.name, lifetime: 1000, decayed: false, decayProducts: [], spawnTime: Date.now(), origin: "right", decayChainLength: 0, distanceTraveled: 0 });
      }
    }
    function createSingleParticlePair() {
      const radius = 8;
      particles.push({ x: radius, y: (bandTop() + bandBottom()) / 2, r: radius, vx: 10, vy: 0, beam: "left", color: selectedParticles.left.color, name: selectedParticles.left.name, lifetime: 1000, decayed: false, decayProducts: [], spawnTime: Date.now(), origin: "left", decayChainLength: 0, distanceTraveled: 0 });
      particles.push({ x: canvas.width - radius, y: (bandTop() + bandBottom()) / 2, r: radius, vx: -10, vy: 0, beam: "right", color: selectedParticles.right.color, name: selectedParticles.right.name, lifetime: 1000, decayed: false, decayProducts: [], spawnTime: Date.now(), origin: "right", decayChainLength: 0, distanceTraveled: 0 });
      if (!animationId) animationId = requestAnimationFrame(loop);
    }
    function drawMomentumArrow(p) { const speed = Math.sqrt(p.vx * p.vx + p.vy * p.vy); if (speed > 0.5) { const scale = 5; const arrowLength = Math.min(speed * scale, 30); const angle = Math.atan2(p.vy, p.vx); const isAntimatter = p.name.includes("Anti") || p.name.includes("anti"); const color = isAntimatter ? 'purple' : 'hotpink'; ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(p.x + Math.cos(angle) * arrowLength, p.y + Math.sin(angle) * arrowLength); ctx.stroke(); const headLength = 10; ctx.beginPath(); ctx.moveTo(p.x + Math.cos(angle) * arrowLength, p.y + Math.sin(angle) * arrowLength); ctx.lineTo(p.x + Math.cos(angle - Math.PI / 6) * (arrowLength - headLength), p.y + Math.sin(angle - Math.PI / 6) * (arrowLength - headLength)); ctx.lineTo(p.x + Math.cos(angle + Math.PI / 6) * (arrowLength - headLength), p.y + Math.sin(angle + Math.PI / 6) * (arrowLength - headLength)); ctx.closePath(); ctx.fillStyle = color; ctx.fill(); } }
    function drawParticles() { ctx.fillStyle = "rgba(50, 50, 100, 0.1)"; ctx.fillRect(0, bandTop(), canvas.width, bandBottom() - bandTop()); for (let p of particles) { if (!p.decayed) { ctx.shadowColor = p.color; ctx.shadowBlur = 15; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2); ctx.fill(); ctx.shadowBlur = 0; ctx.fillStyle = "#ffffff"; ctx.beginPath(); ctx.arc(p.x, p.y, p.r * 0.4, 0, Math.PI * 2); ctx.fill(); if (momentumCheckbox.checked) drawMomentumArrow(p); } if (p.decayProducts) { for (let dp of p.decayProducts) { if (dp.lifetime > 0) { if (dp.trail) { for (let i = 0; i < dp.trail.length; i++) { const point = dp.trail[i]; const alpha = i / dp.trail.length; ctx.fillStyle = `rgba(${parseInt(dp.color.substr(1, 2), 16)}, ${parseInt(dp.color.substr(3, 2), 16)}, ${parseInt(dp.color.substr(5, 2), 16)}, ${alpha * 0.5})`; ctx.beginPath(); ctx.arc(point.x, point.y, dp.r * alpha, 0, Math.PI * 2); ctx.fill(); } } ctx.shadowColor = dp.color; ctx.shadowBlur = 10; ctx.fillStyle = dp.color; ctx.beginPath(); ctx.arc(dp.x, dp.y, dp.r, 0, Math.PI * 2); ctx.fill(); ctx.shadowBlur = 0; ctx.fillStyle = "#ffffff"; ctx.beginPath(); ctx.arc(dp.x, dp.y, dp.r * 0.3, 0, Math.PI * 2); ctx.fill(); if (momentumCheckbox.checked) drawMomentumArrow(dp); } } } } const now = Date.now(); for (let i = collisions.length - 1; i >= 0; i--) { const c = collisions[i]; const elapsed = now - c.time; const duration = 400 / timeScale; if (elapsed > duration) { collisions.splice(i, 1); continue; } const alpha = 1 - elapsed / duration; const gradient = ctx.createRadialGradient(c.x, c.y, 0, c.x, c.y, c.r * 3); gradient.addColorStop(0, `rgba(${c.color.r}, ${c.color.g}, ${c.color.b}, ${alpha})`); gradient.addColorStop(1, `rgba(${c.color.r}, ${c.color.g}, ${c.color.b}, 0)`); ctx.fillStyle = gradient; ctx.beginPath(); ctx.arc(c.x, c.y, c.r * 3, 0, Math.PI * 2); ctx.fill(); } }
    function updateParticles() { for (let p of [...particles, ...particles.flatMap(p => p.decayProducts || [])]) { if (p.decayed || p.lifetime <= 0) continue; const dx = p.vx * timeScale; const dy = p.vy * timeScale; p.distanceTraveled = (p.distanceTraveled || 0) + Math.sqrt(dx * dx + dy * dy); p.x += dx; p.y += dy; if (p.beam) { if (p.y < bandTop() + p.r || p.y > bandBottom() - p.r) p.vy *= -1; } else { p.vy += 0.05 * timeScale; } if (p.trail) { p.trail.push({ x: p.x, y: p.y }); if (p.trail.length > 10) p.trail.shift(); } p.lifetime -= timeScale; } detectCollisions(); }
    function getParticleProperties(name) { const properties = { 'Up Quark': { mass: '~2.2 MeV', charge: '+2/3', lifetime: 'Bound/stable' }, 'Anti-Up Quark': { mass: '~2.2 MeV', charge: '-2/3', lifetime: 'Bound/stable' }, 'Down Quark': { mass: '~4.7 MeV', charge: '-1/3', lifetime: 'Bound/stable' }, 'Anti-Down Quark': { mass: '~4.7 MeV', charge: '+1/3', lifetime: 'Bound/stable' }, 'Strange Quark': { mass: '~96 MeV', charge: '-1/3', lifetime: '~10‚Åª¬π‚Å∞ s' }, 'Anti-Strange Quark': { mass: '~96 MeV', charge: '+1/3', lifetime: '~10‚Åª¬π‚Å∞ s' }, 'Charm Quark': { mass: '~1.27 GeV', charge: '+2/3', lifetime: '~10‚Åª¬π¬≥ s' }, 'Anti-Charm Quark': { mass: '~1.27 GeV', charge: '-2/3', lifetime: '~10‚Åª¬π¬≥ s' }, 'Bottom Quark': { mass: '~4.18 GeV', charge: '-1/3', lifetime: '~1.6√ó10‚Åª¬π¬≤ s' }, 'Anti-Bottom Quark': { mass: '~4.18 GeV', charge: '+1/3', lifetime: '~1.6√ó10‚Åª¬π¬≤ s' }, 'Top Quark': { mass: '~173 GeV', charge: '+2/3', lifetime: '~5√ó10‚Åª¬≤‚Åµ s' }, 'Anti-Top Quark': { mass: '~173 GeV', charge: '-2/3', lifetime: '~5√ó10‚Åª¬≤‚Åµ s' }, 'Electron': { mass: '0.511 MeV', charge: '-1', lifetime: 'Stable' }, 'Positron': { mass: '0.511 MeV', charge: '+1', lifetime: 'Stable (annihilates)' }, 'Muon': { mass: '105.7 MeV', charge: '-1', lifetime: '2.2√ó10‚Åª‚Å∂ s' }, 'Anti-Muon': { mass: '105.7 MeV', charge: '+1', lifetime: '2.2√ó10‚Åª‚Å∂ s' }, 'Tau': { mass: '1776.86 MeV', charge: '-1', lifetime: '2.9√ó10‚Åª¬π¬≥ s' }, 'Anti-Tau': { mass: '1776.86 MeV', charge: '+1', lifetime: '2.9√ó10‚Åª¬π¬≥ s' }, 'Electron Neutrino': { mass: '< 2.2 eV', charge: '0', lifetime: 'Stable' }, 'Anti-Electron Neutrino': { mass: '< 2.2 eV', charge: '0', lifetime: 'Stable' }, 'Muon Neutrino': { mass: '< 0.17 MeV', charge: '0', lifetime: 'Stable' }, 'Anti-Muon Neutrino': { mass: '< 0.17 MeV', charge: '0', lifetime: 'Stable' }, 'Tau Neutrino': { mass: '< 18.2 MeV', charge: '0', lifetime: 'Stable' }, 'Anti-Tau Neutrino': { mass: '< 18.2 MeV', charge: '0', lifetime: 'Stable' }, 'Photon': { mass: '0', charge: '0', lifetime: 'Stable' }, 'W Boson': { mass: '~80.4 GeV', charge: '¬±1', lifetime: '~3√ó10‚Åª¬≤‚Åµ s' }, 'Anti-W Boson': { mass: '~80.4 GeV', charge: '‚àì1', lifetime: '~3√ó10‚Åª¬≤‚Åµ s' }, 'Z Boson': { mass: '~91.2 GeV', charge: '0', lifetime: '~3√ó10‚Åª¬≤‚Åµ s' }, 'Gluon': { mass: '0', charge: '0', lifetime: 'Stable (confined)' }, 'Graviton': { mass: '0', charge: '0', lifetime: 'Unknown' }, 'Higgs Boson': { mass: '~125.1 GeV', charge: '0', lifetime: '~1.6√ó10‚Åª¬≤¬≤ s' }, 'Proton': { mass: '938.3 MeV', charge: '+1', lifetime: 'Stable' }, 'Anti-Proton': { mass: '938.3 MeV', charge: '-1', lifetime: 'Stable' }, 'Neutron': { mass: '939.6 MeV', charge: '0', lifetime: '881 s (free)' }, 'Anti-Neutron': { mass: '939.6 MeV', charge: '0', lifetime: '881 s (free)' }, 'Pion': { mass: '139.6 MeV', charge: '0', lifetime: '2.6√ó10‚Åª‚Å∏ s' }, 'Charged Pion': { mass: '139.6 MeV', charge: '¬±1', lifetime: '2.6√ó10‚Åª‚Å∏ s' } }; return properties[name] || { mass: 'Unknown', charge: 'Unknown', lifetime: 'Unknown' }; }
    function getMassValue(name) { const masses = { 'Electron': 0.511, 'Positron': 0.511, 'Muon': 105.7, 'Anti-Muon': 105.7, 'Tau': 1776.86, 'Anti-Tau': 1776.86, 'Photon': 0, 'Proton': 938.3, 'Anti-Proton': 938.3, 'Neutron': 939.6, 'Anti-Neutron': 939.6, 'Pion': 139.6, 'Charged Pion': 139.6, 'W Boson': 80400, 'Anti-W Boson': 80400, 'Z Boson': 91200, 'Higgs Boson': 125100 }; return masses[name] || 100; }
    function startDecaySequence(particle) { if (particle.decayed) return; particle.decayed = true; decayCounter++; const decayProducts = generateDecayProducts(particle); const decayString = `${particle.name} ‚Üí ${decayProducts.map(p => p.name).join(" + ")}`; decayLog.push({ parentType: particle.name, childrenTypes: decayProducts.map(p => p.name), time: Date.now(), decayString: decayString }); particle.decayProducts = []; particleLifetimes.push((Date.now() - particle.spawnTime) / 1000); for (let i = 0; i < decayProducts.length; i++) { const decayParticle = decayProducts[i]; const angle = Math.random() * Math.PI * 2; const speed = 2 + Math.random() * 4; const decayProduct = { x: particle.x, y: particle.y, r: particle.r * 0.6, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, color: getColorForParticle(decayParticle.name), name: decayParticle.name, lifetime: decayParticle.lifetime || (100 + Math.random() * 200), spawnTime: Date.now(), origin: "decay", decayChainLength: particle.decayChainLength + 1, distanceTraveled: 0 }; if (["Photon", "Muon", "Tau", "W", "Z"].some(p => decayParticle.name.includes(p))) { if (decayParticle.name.includes("Photon")) decayProduct.lifetime = 50; else decayProduct.trail = []; } particle.decayProducts.push(decayProduct); } }
    function generateDecayProducts(particle) { const name = particle.name; if (name === "Strange Quark") return [{ name: "Up Quark", lifetime: 150 }, { name: "Electron", lifetime: 150 }, { name: "Anti-Electron Neutrino", lifetime: 100 }]; if (name === "Charm Quark") return [{ name: "Strange Quark", lifetime: 150 }, { name: "Positron", lifetime: 150 }, { name: "Electron Neutrino", lifetime: 100 }]; if (name === "Bottom Quark") return [{ name: "Charm Quark", lifetime: 200 }, { name: "Electron", lifetime: 150 }, { name: "Anti-Electron Neutrino", lifetime: 100 }]; if (name === "Top Quark") return [{ name: "Bottom Quark", lifetime: 50 }, { name: "Positron", lifetime: 50 }, { name: "Electron Neutrino", lifetime: 50 }]; if (name === "Muon") return [{ name: "Electron", lifetime: 200 }, { name: "Electron Neutrino", lifetime: 100 }, { name: "Anti-Muon Neutrino", lifetime: 100 }]; if (name === "Anti-Muon") return [{ name: "Positron", lifetime: 200 }, { name: "Anti-Electron Neutrino", lifetime: 100 }, { name: "Muon Neutrino", lifetime: 100 }]; if (name === "Tau") { const rand = Math.random(); if (rand < 0.5) return [{ name: "Muon", lifetime: 100 }, { name: "Muon Neutrino", lifetime: 80 }, { name: "Anti-Tau Neutrino", lifetime: 80 }]; else return [{ name: "Electron", lifetime: 100 }, { name: "Electron Neutrino", lifetime: 80 }, { name: "Anti-Tau Neutrino", lifetime: 80 }]; } if (name === "Anti-Tau") { const rand = Math.random(); if (rand < 0.5) return [{ name: "Anti-Muon", lifetime: 100 }, { name: "Anti-Muon Neutrino", lifetime: 80 }, { name: "Tau Neutrino", lifetime: 80 }]; else return [{ name: "Positron", lifetime: 100 }, { name: "Anti-Electron Neutrino", lifetime: 80 }, { name: "Tau Neutrino", lifetime: 80 }]; } if (name === "W Boson") return [{ name: "Positron", lifetime: 50 }, { name: "Electron Neutrino", lifetime: 50 }]; if (name === "Anti-W Boson") return [{ name: "Electron", lifetime: 50 }, { name: "Anti-Electron Neutrino", lifetime: 50 }]; if (name === "Z Boson") { const rand = Math.random(); if (rand < 0.33) return [{ name: "Electron", lifetime: 50 }, { name: "Positron", lifetime: 50 }]; else if (rand < 0.66) return [{ name: "Muon", lifetime: 50 }, { name: "Anti-Muon", lifetime: 50 }]; else return [{ name: "Up Quark", lifetime: 50 }, { name: "Anti-Up Quark", lifetime: 50 }]; } if (name === "Higgs Boson") { const rand = Math.random(); if (rand < 0.25) return [{ name: "Bottom Quark", lifetime: 100 }, { name: "Anti-Bottom Quark", lifetime: 100 }]; else if (rand < 0.5) return [{ name: "W Boson", lifetime: 100 }, { name: "Anti-W Boson", lifetime: 100 }]; else if (rand < 0.75) return [{ name: "Tau", lifetime: 100 }, { name: "Anti-Tau", lifetime: 100 }]; else return [{ name: "Z Boson", lifetime: 100 }, { name: "Z Boson", lifetime: 100 }]; } if (name === "Proton" || name === "Anti-Proton") { const count = 2 + Math.floor(Math.random() * 3); const products = []; for (let i = 0; i < count; i++) { const rand = Math.random(); if (rand < 0.3) products.push({ name: "Pion", lifetime: 150 }); else if (rand < 0.5) products.push({ name: "Charged Pion", lifetime: 150 }); else if (rand < 0.7) products.push({ name: "Muon", lifetime: 200 }); else if (rand < 0.9) products.push({ name: "Electron Neutrino", lifetime: 100 }); else products.push({ name: "Photon", lifetime: 50 }); } return products; } if ((name === "Electron" && particle.beam === "left") && (particles.find(p => p.name === "Positron" && p.beam === "right" && !p.decayed))) return [{ name: "Photon", lifetime: 30 }, { name: "Photon", lifetime: 30 }]; if ((name === "Positron" && particle.beam === "right") && (particles.find(p => p.name === "Electron" && p.beam === "left" && !p.decayed))) return [{ name: "Photon", lifetime: 30 }, { name: "Photon", lifetime: 30 }]; return [{ name: "Photon", lifetime: 50 }]; }
    function detectCollisions() { if (particles.length < 2) return; for (let i = 0; i < particles.length; i++) { const p1 = particles[i]; if (p1.decayed || p1.beam !== "left") continue; for (let j = 0; j < particles.length; j++) { const p2 = particles[j]; if (p2.decayed || p2.beam !== "right") continue; const dx = p1.x - p2.x; const dy = p1.y - p2.y; const dist = Math.sqrt(dx * dx + dy * dy); if (dist < p1.r + p2.r) { let flashColor = { r: 255, g: 255, b: 200 }; if (p1.name.includes("Quark") && p2.name.includes("Quark")) flashColor = { r: 255, g: 100, b: 100 }; else if ((p1.name === "Electron" && p2.name === "Positron") || (p1.name === "Positron" && p2.name === "Electron")) flashColor = { r: 200, g: 230, b: 255 }; else if (p1.name.includes("Muon") || p2.name.includes("Muon")) flashColor = { r: 150, g: 255, b: 150 }; else if (p1.name.includes("Tau") || p2.name.includes("Tau")) flashColor = { r: 200, g: 100, b: 255 }; else if (p1.name.includes("W") || p2.name.includes("W")) flashColor = { r: 255, g: 255, b: 0 }; else if (p1.name.includes("Z") || p2.name.includes("Z")) flashColor = { r: 100, g: 255, b: 100 }; else if (p1.name.includes("Higgs") || p2.name.includes("Higgs")) flashColor = { r: 255, g: 200, b: 220 }; else if ((p1.name === "Proton" && p2.name === "Anti-Proton") || (p1.name === "Anti-Proton" && p2.name === "Proton")) flashColor = { r: 255, g: 165, b: 0 }; collisions.push({ x: (p1.x + p2.x) / 2, y: (p1.y + p2.y) / 2, r: (p1.r + p2.r) * 1.5, time: Date.now(), color: flashColor }); collisionTimes.push(Date.now()); startDecaySequence(p1); startDecaySequence(p2); collisionCounter++; } } } }
    function drawSimpleBarChart(containerId, data, labels) { const container = document.getElementById(containerId); if (!container) return; container.innerHTML = ''; if (data.length === 0 || labels.length === 0) return; const maxWidth = container.clientWidth; const maxHeight = container.clientHeight; const barSpacing = 10; const maxBarWidth = (maxWidth - (labels.length + 1) * barSpacing) / labels.length; const barWidth = Math.min(maxBarWidth, 30); const maxValue = Math.max(...data, 1); const svgNS = "http://www.w3.org/2000/svg"; const svg = document.createElementNS(svgNS, "svg"); svg.setAttribute("width", "100%"); svg.setAttribute("height", "100%"); svg.setAttribute("viewBox", `0 0 ${maxWidth} ${maxHeight}`); const startY = maxHeight - 20; labels.forEach((label, i) => { const value = data[i]; const barHeight = (value / maxValue) * (maxHeight - 30); const group = document.createElementNS(svgNS, "g"); group.setAttribute("transform", `translate(${barSpacing + i * (barWidth + barSpacing)}, 0)`); const rect = document.createElementNS(svgNS, "rect"); rect.setAttribute("x", "0"); rect.setAttribute("y", `${startY - barHeight}`); rect.setAttribute("width", barWidth); rect.setAttribute("height", barHeight); rect.setAttribute("fill", `hsl(${i * 360 / labels.length}, 70%, 60%)`); group.appendChild(rect); const textLabel = document.createElementNS(svgNS, "text"); textLabel.setAttribute("x", barWidth / 2); textLabel.setAttribute("y", `${startY + 5}`); textLabel.setAttribute("text-anchor", "middle"); textLabel.setAttribute("font-size", "8"); textLabel.setAttribute("fill", "white"); textLabel.textContent = label.length > 8 ? label.substring(0, 8) + "..." : label; group.appendChild(textLabel); const textValue = document.createElementNS(svgNS, "text"); textValue.setAttribute("x", barWidth / 2); textValue.setAttribute("y", `${startY - barHeight - 5}`); textValue.setAttribute("text-anchor", "middle"); textValue.setAttribute("font-size", "8"); textValue.setAttribute("fill", "white"); textValue.textContent = value.toFixed(1); group.appendChild(textValue); svg.appendChild(group); }); container.appendChild(svg); }
    function updateStatsData() { const now = Date.now(); totalSimulationTime = (now - simulationStartTime) / 1000; let typeCounts = {}; let activeParticleCount = 0; let decayedParticleCount = 0; let beamParticleCount = 0; let decayParticleCount = 0; let maxDecayChainLength = 0; let speedSum = 0; let energySum = 0; let maxEnergyValue = 0; let minEnergyValue = Infinity; let maxEnergyParticle = "None"; let minEnergyParticle = "None"; let totalDistanceTraveled = 0; let beamEnergySum = 0; let decayEnergySum = 0; const allActiveParticles = [...particles.filter(p => !p.decayed), ...particles.flatMap(p => p.decayProducts || []).filter(dp => dp.lifetime > 0)]; for (const p of allActiveParticles) { activeParticleCount++; if (p.origin === "left" || p.origin === "right") beamParticleCount++; else decayParticleCount++; typeCounts[p.name] = (typeCounts[p.name] || 0) + 1; maxDecayChainLength = Math.max(maxDecayChainLength, p.decayChainLength); const speed = Math.sqrt(p.vx * p.vx + p.vy * p.vy); const mass = getMassValue(p.name); const energy = 0.5 * mass * speed * speed; speedSum += speed; energySum += energy; totalDistanceTraveled += p.distanceTraveled || 0; if (energy > maxEnergyValue) { maxEnergyValue = energy; maxEnergyParticle = p.name; } if (energy < minEnergyValue) { minEnergyValue = energy; minEnergyParticle = p.name; } if (p.origin === "left" || p.origin === "right") beamEnergySum += energy; else decayEnergySum += energy; } decayedParticleCount = particles.filter(p => p.decayed).length; const totalParticleCount = activeParticleCount + decayedParticleCount; const fiveSecondsAgo = now - 5000; collisionTimes = collisionTimes.filter(time => time > fiveSecondsAgo); const collisionRateValue = totalSimulationTime > 0 ? collisionTimes.length / Math.min(5, totalSimulationTime) : 0; const decayRateValue = totalSimulationTime > 0 ? decayCounter / totalSimulationTime : 0; const avgLifetimeValue = particleLifetimes.length > 0 ? particleLifetimes.reduce((a, b) => a + b, 0) / particleLifetimes.length : 0; const avgDistanceTraveled = activeParticleCount > 0 ? totalDistanceTraveled / activeParticleCount : 0; const avgBeamEnergy = beamParticleCount > 0 ? beamEnergySum / beamParticleCount : 0; const avgDecayEnergy = decayParticleCount > 0 ? decayEnergySum / decayParticleCount : 0; const currentTime = totalSimulationTime; statsData.totalParticles.push({ time: currentTime, value: totalParticleCount }); statsData.activeDecayed.push({ time: currentTime, active: activeParticleCount, decayed: decayedParticleCount }); statsData.beamParticles.push({ time: currentTime, value: beamParticleCount }); statsData.decayParticles.push({ time: currentTime, value: decayParticleCount }); statsData.maxDecayChain.push({ time: currentTime, value: maxDecayChainLength }); statsData.avgSpeed.push({ time: currentTime, value: activeParticleCount > 0 ? speedSum / activeParticleCount : 0 }); statsData.avgEnergy.push({ time: currentTime, value: activeParticleCount > 0 ? energySum / activeParticleCount : 0 }); statsData.maxEnergy.push({ time: currentTime, value: maxEnergyValue, particle: maxEnergyParticle }); statsData.minEnergy.push({ time: currentTime, value: minEnergyValue === Infinity ? 0 : minEnergyValue, particle: minEnergyParticle }); statsData.totalDistance.push({ time: currentTime, value: totalDistanceTraveled }); statsData.avgDistance.push({ time: currentTime, value: avgDistanceTraveled }); statsData.avgLifetime.push({ time: currentTime, value: avgLifetimeValue }); statsData.collisions.push({ time: currentTime, count: collisionCounter, rate: collisionRateValue }); statsData.decays.push({ time: currentTime, count: decayCounter, rate: decayRateValue }); statsData.beamEnergy.push({ time: currentTime, value: avgBeamEnergy }); statsData.decayEnergy.push({ time: currentTime, value: avgDecayEnergy }); statsData.composition.push({ time: currentTime, counts: typeCounts }); document.getElementById('totalParticles').textContent = totalParticleCount; document.getElementById('activeDecayed').textContent = `${activeParticleCount} / ${decayedParticleCount}`; document.getElementById('beamParticles').textContent = beamParticleCount; document.getElementById('decayParticles').textContent = decayParticleCount; document.getElementById('maxDecayChain').textContent = maxDecayChainLength; document.getElementById('collisionCount').textContent = collisionCounter; document.getElementById('collisionRate').textContent = collisionRateValue.toFixed(1); document.getElementById('decayCount').textContent = decayCounter; document.getElementById('decayRate').textContent = decayRateValue.toFixed(2); document.getElementById('avgLifetime').textContent = avgLifetimeValue.toFixed(2); document.getElementById('avgSpeed').textContent = (activeParticleCount > 0 ? speedSum / activeParticleCount : 0).toFixed(2); document.getElementById('avgEnergy').textContent = (activeParticleCount > 0 ? energySum / activeParticleCount : 0).toFixed(2); document.getElementById('totalDistance').textContent = totalDistanceTraveled.toFixed(2); document.getElementById('avgDistance').textContent = avgDistanceTraveled.toFixed(2); document.getElementById('beamEnergy').textContent = avgBeamEnergy.toFixed(2); document.getElementById('decayEnergy').textContent = avgDecayEnergy.toFixed(2); document.getElementById('maxEnergy').textContent = `${maxEnergyValue.toFixed(1)} (${maxEnergyParticle})`; document.getElementById('minEnergy').textContent = minEnergyValue === Infinity ? "0.00 (None)" : `${minEnergyValue.toFixed(1)} (${minEnergyParticle})`; compositionTable.innerHTML = ''; if (Object.keys(typeCounts).length > 0) { const sortedTypes = Object.entries(typeCounts).sort((a, b) => b[1] - a[1]); sortedTypes.forEach(([type, count]) => { const percentage = activeParticleCount > 0 ? (count / activeParticleCount) * 100 : 0; const row = document.createElement('tr'); row.innerHTML = `<td>${type}</td><td>${count}</td><td>${percentage.toFixed(1)}%</td>`; compositionTable.appendChild(row); }); } else { compositionTable.innerHTML = '<tr><td colspan="3">No data</td></tr>'; } if (Object.keys(typeCounts).length > 0) { const sortedTypesForChart = Object.entries(typeCounts).sort((a, b) => b[1] - a[1]).slice(0, 5); drawSimpleBarChart('compositionChart', sortedTypesForChart.map(([, count]) => count), sortedTypesForChart.map(([type]) => type)); } }
    function updateStats() { if (running) updateStatsData(); Object.keys(statsData).forEach(key => { if (key !== 'composition') { updateTable(key, statsData[key], Object.keys(statsData[key][0] || {})); updateChart(key, statsData[key], Array.isArray(statsData[key][0]) ? Object.keys(statsData[key][0]) : 'value'); } }); }
    function updateTable(section, data, columns) { const tableBody = document.getElementById(`${section}TableBody`); if (!tableBody) return; tableBody.innerHTML = ''; data.slice(-10).forEach(item => { const row = document.createElement('tr'); columns.forEach(col => { const cell = document.createElement('td'); cell.textContent = typeof item[col] === 'number' ? item[col].toFixed(2) : item[col]; row.appendChild(cell); }); tableBody.appendChild(row); }); }
    function updateChart(section, data, valueKey) { const chartContainer = document.getElementById(`${section}Chart`); if (!chartContainer) return; chartContainer.innerHTML = ''; if (data.length === 0) return; const canvas = document.createElement('canvas'); canvas.width = chartContainer.clientWidth; canvas.height = chartContainer.clientHeight; chartContainer.appendChild(canvas); const ctx = canvas.getContext('2d'); const width = canvas.width; const height = canvas.height; let values; if (Array.isArray(valueKey)) { values = valueKey.map(key => data.map(item => item[key])); } else { values = [data.map(item => item[valueKey])]; } let allValues = [].concat(...values); const minVal = Math.min(...allValues); const maxVal = Math.max(...allValues); const range = maxVal - minVal || 1; const times = data.map(item => item.time); const minTime = Math.min(...times); const maxTime = Math.max(...times); const timeRange = maxTime - minTime || 1; const padding = 20; const chartWidth = width - padding * 2; const chartHeight = height - padding * 2; ctx.strokeStyle = 'rgba(100, 100, 100, 0.3)'; for (let i = 0; i <= 5; i++) { const y = padding + chartHeight - (i / 5) * chartHeight; ctx.beginPath(); ctx.moveTo(padding, y); ctx.lineTo(padding + chartWidth, y); ctx.stroke(); } ctx.strokeStyle = 'rgba(200, 200, 200, 0.7)'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(padding, padding); ctx.lineTo(padding, padding + chartHeight); ctx.lineTo(padding + chartWidth, padding + chartHeight); ctx.stroke(); const colors = ['#4dabf7', '#ff6b6b', '#51cf66', '#fcc419', '#cc5de8']; values.forEach((valueArray, idx) => { if (valueArray.length < 2) return; ctx.strokeStyle = colors[idx % colors.length]; ctx.lineWidth = 2; ctx.beginPath(); valueArray.forEach((val, i) => { const x = padding + ((times[i] - minTime) / timeRange) * chartWidth; const y = padding + chartHeight - ((val - minVal) / range) * chartHeight; if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); }); ctx.stroke(); }); ctx.fillStyle = 'white'; ctx.font = '8px Arial'; ctx.textAlign = 'right'; for (let i = 0; i <= 5; i++) { const val = minVal + (i / 5) * range; const y = padding + chartHeight - (i / 5) * chartHeight; ctx.fillText(val.toFixed(1), padding - 5, y + 3); } }

    function loop() {
      if (!running && particles.every(p => p.decayed && (!p.decayProducts || p.decayProducts.every(dp => dp.lifetime <= 0))) && collisions.length === 0) {
        animationId = null;
        return;
      }
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if(running) updateParticles();
      drawParticles();
      if (statsCheckbox.checked) updateStats();
      animationId = requestAnimationFrame(loop);
    }
    
    function startSpawning() {
      if (spawnIntervalId) clearInterval(spawnIntervalId);
      spawnIntervalId = setInterval(createParticles, baseSpawnInterval / timeScale);
    }

    function stopSpawning() {
      if (spawnIntervalId) {
        clearInterval(spawnIntervalId);
        spawnIntervalId = null;
      }
    }

    playPauseBtn.addEventListener("click", () => {
      if (!running) { // If was paused, now playing
        running = true;
        resetStatsData();
        playPauseBtn.textContent = "‚è∏Ô∏è";
        if (!animationId) animationId = requestAnimationFrame(loop);
        startSpawning();
      } else { // If was playing, now paused
        running = false;
        playPauseBtn.textContent = "‚ñ∂Ô∏è";
        stopSpawning();
      }
    });

    resetBtn.addEventListener("click", () => {
      running = false;
      playPauseBtn.textContent = "‚ñ∂Ô∏è";
      stopSpawning();
      particles.length = 0;
      collisions.length = 0;
      resetStatsData();
      updateStatsData(); // Update UI to show cleared stats
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });
    
    oneParticleBtn.addEventListener("click", createSingleParticlePair);
    instructionsBtn.addEventListener('click', () => instructionsModal.classList.add('show'));
    closeInstructions.addEventListener('click', () => instructionsModal.classList.remove('show'));
    statsToggle.addEventListener('click', () => {
      statsCheckbox.checked = !statsCheckbox.checked;
      statsDisplay.classList.toggle('show');
      if (statsCheckbox.checked) {
        document.querySelectorAll('.stat-section-title').forEach(title => {
          title.classList.add('collapsed');
          title.nextElementSibling.classList.add('collapsed');
        });
        if (floatingGraphWindow.classList.contains('show')) closeFloatingGraphWindow();
      }
    });
    document.querySelectorAll('.stat-section-title').forEach(title => {
      title.addEventListener('click', () => {
        title.classList.toggle('collapsed');
        title.nextElementSibling.classList.toggle('collapsed');
      });
    });

    // --- Floating Graph Window Logic ---
    const floatingGraphWindow = document.getElementById('floatingGraphWindow');
    let currentFloatingGraphMetric = null;
    let floatingGraphUpdateIntervalId = null;
    const floatingGraphHeader = document.getElementById('floatingGraphHeader');
    const floatingGraphTitle = document.getElementById('floatingGraphTitle');
    const floatingGraphCanvasContainer = document.getElementById('floatingGraphCanvasContainer');
    const closeFloatingGraphBtn = document.getElementById('closeFloatingGraph');
    const friendlyNames = { 'totalParticles': 'Total Particles', 'activeDecayed': 'Active / Decayed Particles', 'beamParticles': 'Particles from Beams', 'decayParticles': 'Particles from Decays', 'maxDecayChain': 'Maximum Decay Chain Length', 'avgSpeed': 'Average Speed', 'avgEnergy': 'Average Energy', 'maxEnergy': 'Maximum Energy', 'minEnergy': 'Minimum Energy', 'totalDistance': 'Total Distance Traveled', 'avgDistance': 'Average Distance Traveled', 'avgLifetime': 'Average Lifetime', 'collisions': 'Collisions', 'decays': 'Decays', 'beamEnergy': 'Average Beam Energy', 'decayEnergy': 'Average Decay Energy', 'composition': 'Particle Composition' };
    
    let isDragging = false;
    let dragOffsetX = 0, dragOffsetY = 0;

    function startDrag(e) { if (e.target === floatingGraphHeader || e.target === floatingGraphTitle) { isDragging = true; const rect = floatingGraphWindow.getBoundingClientRect(); dragOffsetX = e.clientX - rect.left; dragOffsetY = e.clientY - rect.top; floatingGraphWindow.style.left = `${rect.left}px`; floatingGraphWindow.style.top = `${rect.top}px`; document.body.style.cursor = 'move'; e.preventDefault(); } }
    function drag(e) { if (isDragging) { const newX = e.clientX - dragOffsetX; const newY = e.clientY - dragOffsetY; floatingGraphWindow.style.left = `${newX}px`; floatingGraphWindow.style.top = `${newY}px`; } }
    function stopDrag() { isDragging = false; document.body.style.cursor = ''; }
    function attachDragListeners() { floatingGraphHeader.addEventListener('mousedown', startDrag); document.addEventListener('mousemove', drag); document.addEventListener('mouseup', stopDrag); }
    function detachDragListeners() { floatingGraphHeader.removeEventListener('mousedown', startDrag); document.removeEventListener('mousemove', drag); document.removeEventListener('mouseup', stopDrag); isDragging = false; document.body.style.cursor = ''; }

    function showFloatingGraphWindow(metricKey) {
        currentFloatingGraphMetric = metricKey;
        floatingGraphTitle.textContent = friendlyNames[metricKey] || `Graph: ${metricKey}`;
        if (!floatingGraphWindow.style.top || floatingGraphWindow.style.top === '') {
            const rect = floatingGraphWindow.getBoundingClientRect();
            const centerX = (window.innerWidth - rect.width) / 2;
            const centerY = (window.innerHeight - rect.height) / 2;
            floatingGraphWindow.style.left = `${Math.max(centerX, 20)}px`;
            floatingGraphWindow.style.top = `${Math.max(centerY, 20)}px`;
        }
        floatingGraphWindow.classList.add('show');
        drawFloatingChart(metricKey);
        if (floatingGraphUpdateIntervalId) clearInterval(floatingGraphUpdateIntervalId);
        floatingGraphUpdateIntervalId = setInterval(() => { if (floatingGraphWindow.classList.contains('show')) drawFloatingChart(currentFloatingGraphMetric); }, 1000);
        attachDragListeners();
    }

    function closeFloatingGraphWindow() { floatingGraphWindow.classList.remove('show'); currentFloatingGraphMetric = null; if (floatingGraphUpdateIntervalId) { clearInterval(floatingGraphUpdateIntervalId); floatingGraphUpdateIntervalId = null; } detachDragListeners(); }
    closeFloatingGraphBtn.addEventListener('click', closeFloatingGraphWindow);

    document.addEventListener('click', function(event) {
        const graphBtn = event.target.closest('.graph-btn');
        const tableBtn = event.target.closest('.table-btn');
        if (graphBtn) {
            const metricKey = graphBtn.getAttribute('data-metric');
            if (currentFloatingGraphMetric === metricKey && floatingGraphWindow.classList.contains('show')) closeFloatingGraphWindow();
            else showFloatingGraphWindow(metricKey);
        }
        if (tableBtn) {
            const metricKey = tableBtn.getAttribute('data-metric');
            document.getElementById(`${metricKey}Chart`).classList.add('hidden');
            document.getElementById(`${metricKey}Table`).classList.remove('show'); // Mistake in original, should be remove
            document.getElementById(`${metricKey}Table`).classList.add('show');
            tableBtn.parentElement.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            tableBtn.classList.add('active');
        }
    });

    function drawFloatingChart(metricKey) {
        const data = statsData[metricKey];
        if (!data || data.length === 0) { floatingGraphCanvasContainer.innerHTML = `<div style="color:white; text-align:center; padding: 80px 10px;">No data recorded for this run. Press Play (‚ñ∂Ô∏è) to begin.</div>`; return; }
        floatingGraphCanvasContainer.innerHTML = '';
        const canvas = document.createElement('canvas');
        floatingGraphCanvasContainer.appendChild(canvas);
        const ctx = canvas.getContext('2d');
        const containerWidth = floatingGraphCanvasContainer.clientWidth;
        const containerHeight = floatingGraphCanvasContainer.clientHeight;
        canvas.width = containerWidth;
        canvas.height = containerHeight;
        if (metricKey === 'composition') {
            const lastDataPoint = data[data.length - 1];
            const typeCounts = lastDataPoint.counts;
            const sortedTypes = Object.entries(typeCounts).sort((a, b) => b[1] - a[1]).slice(0, 7);
            drawSimpleBarChart('floatingGraphCanvasContainer', sortedTypes.map(([, count]) => count), sortedTypes.map(([type]) => type));
            return;
        }
        let valueKeys = [];
        if (metricKey === 'activeDecayed') valueKeys = ['active', 'decayed'];
        else if (metricKey === 'collisions' || metricKey === 'decays') valueKeys = ['count'];
        else valueKeys = ['value'];
        const times = data.map(d => d.time);
        const datasets = valueKeys.map(key => ({ values: data.map(d => d[key]), key: key }));
        let allValues = [].concat(...datasets.map(d => d.values));
        const minValue = Math.min(...allValues);
        const maxValue = Math.max(...allValues);
        const valueRange = maxValue - minValue || 1;
        const minTime = Math.min(...times);
        const maxTime = Math.max(...times);
        const timeRange = maxTime - minTime || 1;
        const padding = 40;
        const chartWidth = containerWidth - 2 * padding;
        const chartHeight = containerHeight - 2 * padding;
        ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
        ctx.fillRect(0, 0, containerWidth, containerHeight);
        ctx.strokeStyle = 'rgba(100, 100, 100, 0.3)';
        ctx.lineWidth = 1;
        for (let i = 0; i <= 5; i++) { const y = padding + chartHeight - (i / 5) * chartHeight; ctx.beginPath(); ctx.moveTo(padding, y); ctx.lineTo(padding + chartWidth, y); ctx.stroke(); }
        ctx.strokeStyle = 'rgba(200, 200, 200, 0.7)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(padding, padding);
        ctx.lineTo(padding, padding + chartHeight);
        ctx.lineTo(padding + chartWidth, padding + chartHeight);
        ctx.stroke();
        const colors = ['#4dabf7', '#ff6b6b', '#51cf66', '#fcc419', '#cc5de8'];
        datasets.forEach((dataset, dsIdx) => { if (dataset.values.length < 2) return; const color = colors[dsIdx % colors.length]; ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.beginPath(); dataset.values.forEach((val, i) => { const x = padding + ((times[i] - minTime) / timeRange) * chartWidth; const y = padding + chartHeight - ((val - minValue) / valueRange) * chartHeight; if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); }); ctx.stroke(); });
        ctx.fillStyle = 'white';
        ctx.font = '12px Arial';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        for (let i = 0; i <= 5; i++) { const val = minValue + (i / 5) * valueRange; const y = padding + chartHeight - (i / 5) * chartHeight; ctx.fillText(val.toFixed(1), padding - 10, y); }
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        const labelStep = Math.max(1, Math.floor(times.length / 5));
        for (let i = 0; i < times.length; i += labelStep) { const time = times[i]; const x = padding + ((time - minTime) / timeRange) * chartWidth; ctx.fillText(time.toFixed(1) + 's', x, padding + chartHeight + 5); }
        if (datasets.length > 1) { ctx.textAlign = 'left'; ctx.textBaseline = 'top'; datasets.forEach((ds, idx) => { const y = padding + 10 + idx * 15; const color = colors[idx % colors.length]; ctx.fillStyle = color; ctx.fillRect(padding + 10, y, 10, 10); ctx.fillStyle = 'white'; ctx.fillText(ds.key, padding + 25, y); }); }
    }

    // ... (Particle selection modal logic is unchanged)
    const leftParticleBtn = document.getElementById('leftParticleBtn');
    const rightParticleBtn = document.getElementById('rightParticleBtn');
    const particleModal = document.getElementById('particleModal');
    const beamSideLabel = document.getElementById('beamSideLabel');
    const normalParticlesContainer = document.getElementById('normalParticles');
    const antiParticlesContainer = document.getElementById('antiParticles');
    const closeModalBtn = document.getElementById('closeParticleModal');
    let selectingSide = 'left';
    let selectedParticles = { left: { name: 'Proton', color: '#ff6b6b' }, right: { name: 'Anti-Proton', color: '#b33a3a' } };
    function updateParticlePreviews() { /* ... unchanged ... */ }
    updateParticlePreviews();
    const standardModelParticles = [ /* ... unchanged ... */ ];
    function populateParticleGrid(grid, particles) { /* ... unchanged ... */ }
    leftParticleBtn.addEventListener('click', () => { /* ... unchanged ... */ });
    rightParticleBtn.addEventListener('click', () => { /* ... unchanged ... */ });
    closeModalBtn.addEventListener('click', () => particleModal.classList.remove('show'));
    particleModal.addEventListener('click', (e) => { if (e.target === particleModal) particleModal.classList.remove('show'); });
    function invertColor(hex) { if (!hex.startsWith('#')) return hex; let c = hex.substring(1); if (c.length === 3) c = c[0] + c[0] + c[1] + c[1] + c[2] + c[2]; let num = parseInt(c, 16); let r = 255 - ((num >> 16) & 255); let g = 255 - ((num >> 8) & 255); let b = 255 - (num & 255); return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).padStart(6, '0'); }

    // --- CSV Export Functionality ---
    function exportStatsToCsv() {
        if (!statsData.totalParticles || statsData.totalParticles.length === 0) {
            alert("No statistics have been recorded for the current run. Press Play (‚ñ∂Ô∏è) to begin collecting data.");
            return;
        }
        const keyMap = { time: d => d.time.toFixed(3), totalParticles: d => d.value, activeDecayed: d => [d.active, d.decayed], beamParticles: d => d.value, decayParticles: d => d.value, maxDecayChain: d => d.value, avgSpeed: d => d.value.toFixed(2), avgEnergy: d => d.value.toFixed(2), maxEnergy: d => [d.value.toFixed(2), d.particle], minEnergy: d => [d.value.toFixed(2), d.particle], totalDistance: d => d.value.toFixed(2), avgDistance: d => d.value.toFixed(2), avgLifetime: d => d.value.toFixed(2), collisions: d => [d.count, d.rate.toFixed(1)], decays: d => [d.count, d.rate.toFixed(2)], beamEnergy: d => d.value.toFixed(2), decayEnergy: d => d.value.toFixed(2) };
        const headerNames = { time: ["Time(s)"], totalParticles: ["TotalParticles"], activeDecayed: ["ActiveParticles", "DecayedParticles"], beamParticles: ["BeamParticles"], decayParticles: ["DecayParticles"], maxDecayChain: ["MaxDecayChain"], avgSpeed: ["AvgSpeed"], avgEnergy: ["AvgEnergy"], maxEnergy: ["MaxEnergy", "MaxEnergyParticle"], minEnergy: ["MinEnergy", "MinEnergyParticle"], totalDistance: ["TotalDistance"], avgDistance: ["AvgDistance"], avgLifetime: ["AvgLifetime(s)"], collisions: ["TotalCollisions", "CollisionRate(/s)"], decays: ["TotalDecays", "DecayRate(/s)"], beamEnergy: ["AvgBeamEnergy"], decayEnergy: ["AvgDecayEnergy"] };
        const headers = Object.values(headerNames).flat();
        let csvContent = headers.join(",") + "\r\n";
        const numRows = statsData.totalParticles.length;
        for (let i = 0; i < numRows; i++) {
            const row = [];
            for (const key in keyMap) {
                if (statsData[key] && statsData[key][i]) {
                    const values = [].concat(keyMap[key](statsData[key][i]));
                    row.push(...values);
                } else {
                    row.push(...Array(headerNames[key].length).fill(''));
                }
            }
            csvContent += row.map(v => `"${v}"`).join(",") + "\r\n";
        }
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "collider_stats.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    exportCsvBtn.addEventListener('click', exportStatsToCsv);

    // Initial draw
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawParticles();
  });
  </script>
</body>
</html>
