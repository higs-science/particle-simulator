<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>2D Particle Collider</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
      color: #fff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    canvas {
      display: block;
      background: #000;
    }
    #controls {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 10;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      background: rgba(20, 20, 30, 0.85);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(100, 150, 255, 0.2);
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      background: linear-gradient(145deg, #1e3a8a, #2563eb);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
    button:hover {
      background: linear-gradient(145deg, #2563eb, #3b82f6);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
    }
    button:active {
      transform: translateY(1px);
    }
    #resetBtn {
      background: linear-gradient(145deg, #1f2937, #374151);
    }
    #resetBtn:hover {
      background: linear-gradient(145deg, #374151, #4b5563);
    }
    label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #e2e8f0;
      font-size: 14px;
      user-select: none;
    }
    .slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(240, 240, 240, 0.9);
      padding: 8px 15px;
      border-radius: 20px;
      position: relative;
      height: 36px;
    }
    .slider-label {
      color: #333;
      font-weight: 500;
      white-space: nowrap;
    }
    input[type="range"] {
      -webkit-appearance: none;
      width: 120px;
      height: 6px;
      border-radius: 3px;
      background: #ddd;
      outline: none;
      position: relative;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #10b981;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(16, 185, 129, 0.5);
    }
    input[type="number"] {
      width: 60px;
      padding: 5px;
      background: rgba(30, 30, 50, 0.8);
      border: 1px solid #4f46e5;
      border-radius: 4px;
      color: white;
    }
    #statsToggle {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 10;
      background: rgba(20, 20, 30, 0.85);
      border: 1px solid rgba(100, 150, 255, 0.2);
      border-radius: 8px;
      padding: 10px 15px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: white;
    }
    #statsDisplay {
      position: absolute;
      top: 70px;
      right: 20px;
      z-index: 10;
      background: rgba(20, 20, 30, 0.95);
      border: 1px solid rgba(100, 150, 255, 0.2);
      border-radius: 8px;
      padding: 15px;
      font-size: 14px;
      color: #e2e8f0;
      display: none;
      min-width: 300px;
      max-height: 80vh;
      overflow-y: auto;
    }
    #statsDisplay.show {
      display: block;
    }
    .stat-section {
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(100, 150, 255, 0.2);
    }
    .stat-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    .stat-item {
      margin: 5px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .stat-value {
      font-weight: bold;
      color: #a78bfa;
    }
    #leftParticleBtn, #rightParticleBtn {
      position: absolute;
      bottom: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 15px;
      z-index: 10;
      background: rgba(20, 20, 30, 0.85);
      border: 1px solid rgba(100, 150, 255, 0.2);
      border-radius: 12px;
      min-width: 160px;
      cursor: pointer;
    }
    #leftParticleBtn {
      left: 20px;
    }
    #rightParticleBtn {
      right: 20px;
    }
    .particle-preview {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: #f44336;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
      cursor: pointer;
    }
    .particle-info {
      text-align: center;
      font-size: 12px;
      color: #a0aec0;
    }
    .particle-info div {
      margin: 2px 0;
    }
    .beam-line {
      position: absolute;
      height: 2px;
      background: rgba(100, 200, 255, 0.2);
      z-index: 1;
    }
    #topBeam {
      top: 25%;
      left: 0;
      width: 100%;
    }
    #bottomBeam {
      top: 75%;
      left: 0;
      width: 100%;
    }
    #particleModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(10, 15, 30, 0.95);
      border: 2px solid #4f46e5;
      border-radius: 15px;
      padding: 25px;
      display: none;
      z-index: 20;
      color: white;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
      max-height: 80vh;
      overflow-y: auto;
    }
    #particleModal.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, -45%); }
      to { opacity: 1; transform: translate(-50%, -50%); }
    }
    .particle-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin: 15px 0;
    }
    .particle-button {
      padding: 12px;
      text-align: center;
      border: 1px solid #4f46e5;
      border-radius: 8px;
      cursor: pointer;
      background: rgba(30, 30, 50, 0.8);
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .particle-button:hover {
      background: rgba(79, 70, 229, 0.3);
      transform: translateY(-2px);
    }
    .particle-color {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: inline-block;
    }
    .particle-name {
      font-size: 14px;
      font-weight: 500;
    }
    #momentumToggle {
      margin-left: 15px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    #momentumToggle input {
      margin: 0;
    }
  </style>
</head>
<body>
  <div class="beam-line" id="topBeam"></div>
  <div class="beam-line" id="bottomBeam"></div>
  <div id="controls">
    <button id="playPauseBtn">‚ñ∂Ô∏è</button>
    <button id="resetBtn">Reset</button>
    <button id="oneParticleBtn">1 Particle</button>
    <div class="slider-container">
      <span class="slider-label">Time Scale:</span>
      <input id="timeScaleInput" type="range" min="0.1" max="5" step="0.1" value="1" />
      <span id="timeScaleValue">1.0</span>
    </div>
    <label for="particleCountInput">
      Particle Count:
      <input id="particleCountInput" type="number" min="1" max="10" value="4" />
    </label>
    <label id="momentumToggle">
      <input type="checkbox" id="momentumCheckbox">
      <span>Show Momentum</span>
    </label>
  </div>
  
  <button id="statsToggle">
    <input type="checkbox" id="statsCheckbox">
    <label for="statsCheckbox">Statistics</label>
  </button>
  
  <div id="statsDisplay">
    <div class="stat-section">
      <h3>üì¶ Particle Overview</h3>
      <div class="stat-item">
        <span>Total Particles:</span>
        <span id="totalParticles" class="stat-value">0</span>
      </div>
      <div class="stat-item">
        <span>Active / Decayed:</span>
        <span id="activeDecayed" class="stat-value">0 / 0</span>
      </div>
      <div class="stat-item">
        <span>From Beams:</span>
        <span id="beamParticles" class="stat-value">0</span>
      </div>
      <div class="stat-item">
        <span>Collisions:</span>
        <span id="collisionCount" class="stat-value">0</span>
      </div>
    </div>
    
    <div class="stat-section">
      <h3>üìà Energy & Motion</h3>
      <div class="stat-item">
        <span>Average Speed:</span>
        <span id="avgSpeed" class="stat-value">0.00</span>
      </div>
      <div class="stat-item">
        <span>Total Distance:</span>
        <span id="totalDistance" class="stat-value">0.00</span>
      </div>
    </div>
  </div>
  
  <button id="leftParticleBtn">
    <div class="particle-preview" id="leftParticlePreview"></div>
    <div class="particle-info">
      <div id="leftParticleName">Proton</div>
      <div id="leftParticleMass">Mass: 938.3 MeV</div>
      <div id="leftParticleCharge">Charge: +1</div>
    </div>
  </button>
  
  <button id="rightParticleBtn">
    <div class="particle-preview" id="rightParticlePreview"></div>
    <div class="particle-info">
      <div id="rightParticleName">Anti-Proton</div>
      <div id="rightParticleMass">Mass: 938.3 MeV</div>
      <div id="rightParticleCharge">Charge: -1</div>
    </div>
  </button>
  
  <div id="particleModal">
    <h2>Select Particle Type</h2>
    <p>Choose a particle for the <span id="beamSideLabel">left</span> beam:</p>
    <div class="particle-grid" id="particleGrid"></div>
    <button id="closeParticleModal" style="width: 100%; margin-top: 15px;">Close</button>
  </div>

  <canvas id="sim"></canvas>
  
  <script>
    // Particle definitions
    const particleTypes = {
      proton: { name: "Proton", color: "#ff4444", mass: 938.3, charge: 1, lifetime: Infinity },
      antiproton: { name: "Anti-Proton", color: "#ff8888", mass: 938.3, charge: -1, lifetime: Infinity },
      electron: { name: "Electron", color: "#4444ff", mass: 0.511, charge: -1, lifetime: Infinity },
      positron: { name: "Positron", color: "#8888ff", mass: 0.511, charge: 1, lifetime: Infinity },
      neutron: { name: "Neutron", color: "#44ff44", mass: 939.6, charge: 0, lifetime: 880 },
      muon: { name: "Muon", color: "#ffff44", mass: 105.7, charge: -1, lifetime: 2.2 },
      pion: { name: "Pion+", color: "#ff44ff", mass: 139.6, charge: 1, lifetime: 26 },
      kaon: { name: "Kaon+", color: "#44ffff", mass: 493.7, charge: 1, lifetime: 12.4 }
    };

    // Global variables
    const canvas = document.getElementById("sim");
    const ctx = canvas.getContext("2d");
    let particles = [];
    let collisions = [];
    let animationId = null;
    let running = false;
    let spawnIntervalId = null;
    let timeScale = 1;
    let particleCount = 4;
    let collisionCounter = 0;
    let totalDistance = 0;
    let currentBeamSide = 'left';
    
    // Selected particles for each beam
    let selectedParticles = {
      left: particleTypes.proton,
      right: particleTypes.antiproton
    };

    // DOM elements
    const playPauseBtn = document.getElementById("playPauseBtn");
    const resetBtn = document.getElementById("resetBtn");
    const oneParticleBtn = document.getElementById("oneParticleBtn");
    const timeScaleInput = document.getElementById("timeScaleInput");
    const timeScaleValue = document.getElementById("timeScaleValue");
    const particleCountInput = document.getElementById("particleCountInput");
    const statsToggle = document.getElementById("statsToggle");
    const statsCheckbox = document.getElementById("statsCheckbox");
    const statsDisplay = document.getElementById("statsDisplay");
    const momentumCheckbox = document.getElementById("momentumCheckbox");
    const particleModal = document.getElementById("particleModal");
    const leftParticleBtn = document.getElementById("leftParticleBtn");
    const rightParticleBtn = document.getElementById("rightParticleBtn");

    // Initialize canvas
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    // Band boundaries
    const bandTop = () => canvas.height * 0.25;
    const bandBottom = () => canvas.height * 0.75;

    // Update particle previews
    function updateParticlePreview() {
      const leftPreview = document.getElementById("leftParticlePreview");
      const rightPreview = document.getElementById("rightParticlePreview");
      
      leftPreview.style.backgroundColor = selectedParticles.left.color;
      rightPreview.style.backgroundColor = selectedParticles.right.color;
      
      document.getElementById("leftParticleName").textContent = selectedParticles.left.name;
      document.getElementById("rightParticleName").textContent = selectedParticles.right.name;
      
      document.getElementById("leftParticleMass").textContent = `Mass: ${selectedParticles.left.mass} MeV`;
      document.getElementById("rightParticleMass").textContent = `Mass: ${selectedParticles.right.mass} MeV`;
      
      document.getElementById("leftParticleCharge").textContent = `Charge: ${selectedParticles.left.charge > 0 ? '+' : ''}${selectedParticles.left.charge}`;
      document.getElementById("rightParticleCharge").textContent = `Charge: ${selectedParticles.right.charge > 0 ? '+' : ''}${selectedParticles.right.charge}`;
    }

    // Create particle selection modal
    function createParticleGrid() {
      const grid = document.getElementById("particleGrid");
      grid.innerHTML = '';
      
      Object.keys(particleTypes).forEach(key => {
        const particle = particleTypes[key];
        const button = document.createElement("div");
        button.className = "particle-button";
        button.innerHTML = `
          <div class="particle-color" style="background-color: ${particle.color}"></div>
          <div class="particle-name">${particle.name}</div>
        `;
        button.onclick = () => selectParticle(particle);
        grid.appendChild(button);
      });
    }

    function selectParticle(particle) {
      selectedParticles[currentBeamSide] = particle;
      updateParticlePreview();
      closeParticleModal();
    }

    function openParticleModal(side) {
      currentBeamSide = side;
      document.getElementById("beamSideLabel").textContent = side;
      particleModal.classList.add("show");
    }

    function closeParticleModal() {
      particleModal.classList.remove("show");
    }

    // Create particles
    function createParticles() {
      const baseRadius = 6;
      const scaledRadius = baseRadius * (10 / particleCount);
      
      for (let i = 0; i < particleCount; i++) {
        // Left beam particles
        particles.push({
          x: scaledRadius + Math.random() * 30,
          y: bandTop() + Math.random() * (bandBottom() - bandTop()),
          r: scaledRadius,
          vx: 8 + Math.random() * 4,
          vy: (Math.random() - 0.5) * 2,
          beam: "left",
          color: selectedParticles.left.color,
          name: selectedParticles.left.name,
          mass: selectedParticles.left.mass,
          charge: selectedParticles.left.charge,
          lifetime: selectedParticles.left.lifetime === Infinity ? 1000 : selectedParticles.left.lifetime,
          decayed: false,
          spawnTime: Date.now(),
          distanceTraveled: 0
        });
        
        // Right beam particles
        particles.push({
          x: canvas.width - scaledRadius - Math.random() * 30,
          y: bandTop() + Math.random() * (bandBottom() - bandTop()),
          r: scaledRadius,
          vx: -8 - Math.random() * 4,
          vy: (Math.random() - 0.5) * 2,
          beam: "right",
          color: selectedParticles.right.color,
          name: selectedParticles.right.name,
          mass: selectedParticles.right.mass,
          charge: selectedParticles.right.charge,
          lifetime: selectedParticles.right.lifetime === Infinity ? 1000 : selectedParticles.right.lifetime,
          decayed: false,
          spawnTime: Date.now(),
          distanceTraveled: 0
        });
      }
    }

    // Create single particle pair
    function createSingleParticlePair() {
      const radius = 8;
      particles.push({
        x: radius,
        y: (bandTop() + bandBottom()) / 2,
        r: radius,
        vx: 10,
        vy: 0,
        beam: "left",
        color: selectedParticles.left.color,
        name: selectedParticles.left.name,
        mass: selectedParticles.left.mass,
        charge: selectedParticles.left.charge,
        lifetime: selectedParticles.left.lifetime === Infinity ? 1000 : selectedParticles.left.lifetime,
        decayed: false,
        spawnTime: Date.now(),
        distanceTraveled: 0
      });
      
      particles.push({
        x: canvas.width - radius,
        y: (bandTop() + bandBottom()) / 2,
        r: radius,
        vx: -10,
        vy: 0,
        beam: "right",
        color: selectedParticles.right.color,
        name: selectedParticles.right.name,
        mass: selectedParticles.right.mass,
        charge: selectedParticles.right.charge,
        lifetime: selectedParticles.right.lifetime === Infinity ? 1000 : selectedParticles.right.lifetime,
        decayed: false,
        spawnTime: Date.now(),
        distanceTraveled: 0
      });
      
      if (!running) {
        if (!animationId) {
          animationId = requestAnimationFrame(loop);
        }
      }
    }

    // Collision detection
    function detectCollisions() {
      for (let i = 0; i < particles.length; i++) {
        for (let j = i + 1; j < particles.length; j++) {
          const p1 = particles[i];
          const p2 = particles[j];
          
          if (p1.decayed || p2.decayed) continue;
          if (p1.beam === p2.beam) continue; // Same beam particles don't collide
          
          const dx = p1.x - p2.x;
          const dy = p1.y - p2.y;
          const distance = Math.sqrt(dx * dx + dy * dy);
          
          if (distance < p1.r + p2.r) {
            handleCollision(p1, p2);
          }
        }
      }
    }

    // Handle collision
    function handleCollision(p1, p2) {
      collisionCounter++;
      
      // Create collision effect
      collisions.push({
        x: (p1.x + p2.x) / 2,
        y: (p1.y + p2.y) / 2,
        r: (p1.r + p2.r),
        time: Date.now(),
        color: { r: 255, g: 255, b: 0 }
      });
      
      // Simple elastic collision physics
      const dx = p2.x - p1.x;
      const dy = p2.y - p1.y;
      const distance = Math.sqrt(dx * dx + dy * dy);
      
      if (distance === 0) return;
      
      const nx = dx / distance;
      const ny = dy / distance;
      
      // Relative velocity
      const dvx = p2.vx - p1.vx;
      const dvy = p2.vy - p1.vy;
      
      // Relative velocity in collision normal direction
      const dvn = dvx * nx + dvy * ny;
      
      // Do not resolve if velocities are separating
      if (dvn > 0) return;
      
      // Collision impulse
      const impulse = 2 * dvn / (p1.mass + p2.mass);
      
      // Update velocities
      p1.vx += impulse * p2.mass * nx;
      p1.vy += impulse * p2.mass * ny;
      p2.vx -= impulse * p1.mass * nx;
      p2.vy -= impulse * p1.mass * ny;
      
      // Separate particles to prevent overlap
      const overlap = (p1.r + p2.r) - distance;
      const separationX = nx * overlap * 0.5;
      const separationY = ny * overlap * 0.5;
      
      p1.x -= separationX;
      p1.y -= separationY;
      p2.x += separationX;
      p2.y += separationY;
    }

    // Draw momentum arrow
    function drawMomentumArrow(p) {
      const speed = Math.sqrt(p.vx * p.vx + p.vy * p.vy);
      if (speed > 0.5) {
        const scale = 3;
        const arrowLength = Math.min(speed * scale, 25);
        const angle = Math.atan2(p.vy, p.vx);
        
        ctx.strokeStyle = p.color;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(p.x, p.y);
        ctx.lineTo(
          p.x + Math.cos(angle) * arrowLength,
          p.y + Math.sin(angle) * arrowLength
        );
        ctx.stroke();
        
        // Arrowhead
        const headLength = 8;
        ctx.beginPath();
        ctx.moveTo(
          p.x + Math.cos(angle) * arrowLength,
          p.y + Math.sin(angle) * arrowLength
        );
        ctx.lineTo(
          p.x + Math.cos(angle - Math.PI/6) * (arrowLength - headLength),
          p.y + Math.sin(angle - Math.PI/6) * (arrowLength - headLength)
        );
        ctx.lineTo(
          p.x + Math.cos(angle + Math.PI/6) * (arrowLength - headLength),
          p.y + Math.sin(angle + Math.PI/6) * (arrowLength - headLength)
        );
        ctx.closePath();
        ctx.fillStyle = p.color;
        ctx.fill();
      }
    }

    // Update particles
    function updateParticles() {
      for (let p of particles) {
        if (!p.decayed) {
          // Calculate distance for this frame
          const dx = p.vx * timeScale;
          const dy = p.vy * timeScale;
          const distance = Math.sqrt(dx * dx + dy * dy);
          p.distanceTraveled += distance;
          totalDistance += distance;
          
          // Update position
          p.x += dx;
          p.y += dy;
          
          // Bounce off beam boundaries
          if (p.y < bandTop() + p.r || p.y > bandBottom() - p.r) {
            p.vy *= -0.9; // Add some energy loss
          }
          
          // Remove particles that go off screen
          if (p.x < -50 || p.x > canvas.width + 50) {
            p.decayed = true;
          }
          
          // Handle lifetime decay
          if (p.lifetime !== Infinity && p.lifetime > 0) {
            p.lifetime -= timeScale;
            if (p.lifetime <= 0) {
              p.decayed = true;
            }
          }
        }
      }
      
      detectCollisions();
    }

    // Update statistics
    function updateStatistics() {
      const activeParticles = particles.filter(p => !p.decayed);
      const decayedParticles = particles.filter(p => p.decayed);
      
      document.getElementById("totalParticles").textContent = particles.length;
      document.getElementById("activeDecayed").textContent = `${activeParticles.length} / ${decayedParticles.length}`;
      document.getElementById("beamParticles").textContent = particles.filter(p => p.beam).length;
      document.getElementById("collisionCount").textContent = collisionCounter;
      
      if (activeParticles.length > 0) {
        const avgSpeed = activeParticles.reduce((sum, p) => {
          return sum + Math.sqrt(p.vx * p.vx + p.vy * p.vy);
        }, 0) / activeParticles.length;
        document.getElementById("avgSpeed").textContent = avgSpeed.toFixed(2);
      } else {
        document.getElementById("avgSpeed").textContent = "0.00";
      }
      
      document.getElementById("totalDistance").textContent = totalDistance.toFixed(2);
    }

    // Render function
    function render() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Draw beam regions
      ctx.fillStyle = "rgba(50, 50, 100, 0.1)";
      ctx.fillRect(0, bandTop(), canvas.width, bandBottom() - bandTop());
      
      // Draw particles
      for (let p of particles) {
        if (!p.decayed) {
          // Particle glow
          ctx.shadowColor = p.color;
          ctx.shadowBlur = 15;
          ctx.fillStyle = p.color;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
          ctx.fill();
          ctx.shadowBlur = 0;
          
          // Particle core
          ctx.fillStyle = "#ffffff";
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r * 0.4, 0, Math.PI * 2);
          ctx.fill();
          
          // Momentum arrows
          if (momentumCheckbox.checked) {
            drawMomentumArrow(p);
          }
        }
      }
      
      // Draw collision effects
      const now = Date.now();
      for (let i = collisions.length - 1; i >= 0; i--) {
