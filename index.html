<script>
  window.addEventListener("DOMContentLoaded", () => {
    const canvas = document.getElementById("sim");
    const ctx = canvas.getContext("2d");
    const startBtn = document.getElementById("startBtn");

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    let particles = [];
    let animationId = null;
    let running = false;
    const bandTop = () => canvas.height * 0.25;
    const bandBottom = () => canvas.height * 0.75;
    const numParticles = 50;

    function createParticles() {
      for (let i = 0; i < numParticles; i++) {
        particles.push({
          x: Math.random() * 100,
          y: bandTop() + Math.random() * (bandBottom() - bandTop()),
          r: 3,
          vx: 5 + Math.random() * 2,
          vy: (Math.random() - 0.5) * 0.5
        });
        particles.push({
          x: canvas.width - Math.random() * 100,
          y: bandTop() + Math.random() * (bandBottom() - bandTop()),
          r: 3,
          vx: -5 - Math.random() * 2,
          vy: (Math.random() - 0.5) * 0.5
        });
      }
    }

    function drawParticles() {
      ctx.fillStyle = "red";
      for (let p of particles) {
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function updateParticles() {
      for (let p of particles) {
        p.x += p.vx;
        p.y += p.vy;

        if (p.y < bandTop() + p.r || p.y > bandBottom() - p.r) {
          p.vy *= -1;
        }
      }

      // Only spawn new batch if ALL particles are fully onscreen
      const allFullyVisible = particles.every(p => p.x - p.r > 0 && p.x + p.r < canvas.width);
      if (allFullyVisible) {
        createParticles();
      }

      // Remove particles off-screen completely
      particles = particles.filter(p => p.x + p.r > 0 && p.x - p.r < canvas.width);
    }

    function loop() {
      if (!running) return;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      updateParticles();
      drawParticles();
      animationId = requestAnimationFrame(loop);
    }

    startBtn.addEventListener("click", () => {
      if (!running) {
        particles = [];
        createParticles();
        running = true;
        loop();
      }
    });
  });
</script>
